<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Medication Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 420px;
        }
        .dose-item {
            transition: all 0.3s ease;
        }
        /* Mobile-first adjustment for smaller controls */
        .time-controls {
            display: flex;
            flex-direction: column;
            gap: 8px; /* space-y-2 equivalent */
        }
        @media (min-width: 640px) {
            .time-controls {
                flex-direction: row;
                align-items: center;
                gap: 8px; /* space-x-2 equivalent */
            }
        }
    </style>
</head>
<body>
    <!-- Main App Container - NOW VISIBLE IMMEDIATELY -->
    <div id="app-wrapper" class="min-h-screen flex flex-col items-center p-4">

        <header class="w-full container mb-6 pt-8">
            <h1 class="text-3xl font-extrabold text-gray-900 text-center">Capsule Tracker</h1>
            <p id="date-display" class="text-lg text-gray-500 text-center mt-1"></p>
            <p id="user-id-display" class="text-xs text-gray-400 text-center mt-2"></p>
        </header>

        <main id="tracker-container" class="w-full container bg-white shadow-xl rounded-2xl p-6 transition-opacity duration-500">
            <!-- Loading indicator is visible immediately and hides dynamic content -->
            <div id="loading" class="text-center text-gray-500 py-10">
                <svg class="animate-spin h-5 w-5 mr-3 inline-block text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading Tracker...
            </div>
            <div id="doses-list" class="space-y-4 opacity-0">
                <!-- Dose items will be inserted here by JavaScript -->
            </div>
        </main>

        <!-- Initial Doses Prompt Modal -->
        <div id="doses-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Daily Doses Setup</h2>
                <p class="text-gray-600 mb-4">How many times a day do you need to take your capsule?</p>
                <div class="flex flex-col space-y-4">
                    <input type="number" id="doses-input" min="1" max="10" placeholder="e.g., 4"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <button id="set-doses-btn"
                            class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Start Tracking
                    </button>
                    <p id="modal-error" class="text-red-500 text-sm mt-2 hidden">Please enter a valid number of doses (1-10).</p>
                </div>
            </div>
        </div>
        
        <!-- General Message/Error Modal -->
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                <h2 id="message-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
                <p id="message-content" class="text-gray-600 mb-6"></p>
                <button id="message-close-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Close
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // === HARDCODED FIREBASE CONFIGURATION (FOR STANDALONE USE) ================
        // This configuration uses the one you provided in your last message.
        // =========================================================================
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCftGEAH6VuXJPedpCU42aF1wHMwbDmzdk",
          authDomain: "capsuletracker.firebaseapp.com",
          projectId: "capsuletracker",
          storageBucket: "capsuletracker.firebasestorage.app",
          messagingSenderId: "701645703776",
          appId: "1:701645703776:web:36efba22495d83a56a5105",
          measurementId: "G-97NRLCYX0N"
        };              
        // Use a static App ID and null for the auth token for standalone use.
        const appId = 'capsule-tracker-app';
        const initialAuthToken = null;
        // =========================================================================
        
        let db, auth, userId = null;
        let unsubscribeSnapshot = null;

        setLogLevel('Debug'); // Enable Firestore logging

        // --- Utility Functions ---

        /**
         * Gets the current date formatted as YYYY-MM-DD for use as a Firestore document ID.
         */
        function getTodayDateId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Formats the current date for display.
         */
        function formatDisplayDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date().toLocaleDateString(undefined, options);
        }

        /**
         * Converts 24h time string (e.g., "14:30") to 12h display string (e.g., "2:30 PM").
         */
        function formatTimeForDisplay(time24h) {
            if (!time24h) return 'Not Set';
            try {
                const [hour, minute] = time24h.split(':').map(Number);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12; // Convert 0 to 12
                const displayMinute = String(minute).padStart(2, '0');
                return `${displayHour}:${displayMinute} ${ampm}`;
            } catch (e) {
                return 'Invalid Time';
            }
        }

        /**
         * Shows a custom message modal.
         */
        function showMessage(title, content) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        document.getElementById('message-close-btn').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });

        // --- Firestore Data Operations ---

        /**
         * Gets the document reference for today's doses.
         */
        function getTodayDocRef() {
            if (!db || !userId) return null;
            const todayId = getTodayDateId();
            // Path: /artifacts/{appId}/users/{userId}/medication_tracker/{YYYY-MM-DD}
            const collectionPath = `artifacts/${appId}/users/${userId}/medication_tracker`;
            return doc(db, collectionPath, todayId);
        }

        /**
         * Saves the initial number of doses and sets up the document.
         */
        async function saveInitialDoses(dosesPerDay) {
            const docRef = getTodayDocRef();
            if (!docRef) return;

            const initialDoses = Array.from({ length: dosesPerDay }, (_, i) => ({
                id: i + 1,
                isTaken: false,
                time: '', // Stores 24h HH:MM string or empty
            }));

            const data = {
                dosesPerDay: dosesPerDay,
                doses: initialDoses,
                lastUpdated: new Date().toISOString(),
                userId: userId
            };

            try {
                await setDoc(docRef, data);
                console.log("Initial doses saved successfully.");
                document.getElementById('doses-list').classList.remove('opacity-0');
            } catch (error) {
                console.error("Error saving initial doses:", error);
                showMessage("Database Error", "Could not save the initial dose configuration. Check Firebase permissions.");
            }
        }

        /**
         * Updates the status or time of a single dose.
         */
        async function updateDose(doseId, newStatus, newTime) {
            const docRef = getTodayDocRef();
            if (!docRef) return;

            try {
                let currentDosesData = window.__currentDosesData; 
                if (!currentDosesData || !currentDosesData.doses) {
                    console.error("Dose data not ready for update.");
                    return;
                }

                let dosesArray = [...currentDosesData.doses];
                const doseIndex = dosesArray.findIndex(d => d.id === doseId);

                if (doseIndex > -1) {
                    if (newStatus !== undefined) dosesArray[doseIndex].isTaken = newStatus;
                    if (newTime !== undefined) dosesArray[doseIndex].time = newTime; // newTime is HH:MM or ''

                    await setDoc(docRef, {
                        doses: dosesArray,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    
                    console.log(`Dose ${doseId} updated successfully.`);
                }
            } catch (error) {
                console.error("Error updating dose:", error);
                showMessage("Database Error", "Could not save your dose update. Please check your connection.");
            }
        }


        // --- UI Rendering ---

        /**
         * Renders the list of doses based on the data.
         */
        function renderDosesList(data) {
            const dosesList = document.getElementById('doses-list');
            dosesList.innerHTML = '';
            
            // Show content area and hide loading spinner
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('doses-list').classList.remove('opacity-0');
            
            if (!data || !data.doses || data.doses.length === 0) {
                dosesList.innerHTML = '<p class="text-center text-gray-500 pt-4">No doses configured yet. Please set your daily doses.</p>';
                document.getElementById('doses-modal').classList.remove('hidden');
                return;
            }
            
            window.__currentDosesData = data; 
            
            data.doses.forEach((dose, index) => {
                const isTaken = dose.isTaken || false;
                const time24hValue = dose.time || ''; // Time stored as HH:MM
                const displayTime = formatTimeForDisplay(time24hValue);

                const item = document.createElement('div');
                item.className = `dose-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-xl shadow-md ${isTaken ? 'bg-emerald-50 ring-2 ring-emerald-300' : 'bg-white hover:bg-gray-50'}`;
                item.setAttribute('data-dose-id', dose.id);

                item.innerHTML = `
                    <div class="flex items-center space-x-4 mb-2 sm:mb-0">
                        <input type="checkbox" id="dose-check-${dose.id}" ${isTaken ? 'checked' : ''}
                                class="h-6 w-6 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                        <label for="dose-check-${dose.id}" class="text-lg font-semibold text-gray-800 select-none">
                            Dose ${index + 1}
                        </label>
                        ${time24hValue ? `<span class="text-xs font-medium text-gray-500 ml-4">${displayTime}</span>` : ''}
                    </div>
                    
                    <div class="time-controls ml-10 sm:ml-0">
                        <!-- Time Input (24h format internally, native picker handles display) -->
                        <input type="time" id="dose-time-input-${dose.id}" value="${time24hValue}"
                                class="w-32 p-2 border border-gray-300 rounded-lg text-gray-700 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        
                        <!-- Set Button -->
                        <button data-action="set" data-id="${dose.id}" 
                                class="time-control-btn bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 text-sm shadow-md flex-shrink-0">
                            Set Time
                        </button>
                        <!-- Clear Button -->
                        <button data-action="clear" data-id="${dose.id}" 
                                class="time-control-btn bg-red-100 text-red-700 p-2 rounded-lg hover:bg-red-200 transition duration-150 text-sm shadow-md flex-shrink-0">
                            Clear
                        </button>
                    </div>
                `;
                
                dosesList.appendChild(item);

                // Add event listener for the checkbox status change
                const checkbox = item.querySelector(`#dose-check-${dose.id}`);
                checkbox.addEventListener('change', (e) => {
                    updateDose(dose.id, e.target.checked, undefined);
                });
            });

            // If all doses are taken, maybe show a congratulatory message
            const allTaken = data.doses.every(d => d.isTaken);
            if (data.doses.length > 0 && allTaken) {
                dosesList.insertAdjacentHTML('beforeend', '<p class="text-center text-emerald-600 font-semibold mt-6 p-4 bg-emerald-100 rounded-lg">ðŸŽ‰ All doses for today have been logged! Great job!</p>');
            }
        }

        // --- Event Delegation for Time Controls (Set/Clear) ---
        document.getElementById('tracker-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('time-control-btn')) {
                const doseId = parseInt(e.target.dataset.id, 10);
                const timeInput = document.getElementById(`dose-time-input-${doseId}`);
                
                if (e.target.dataset.action === 'set') {
                    if (timeInput.value) {
                        updateDose(doseId, undefined, timeInput.value); // Saves HH:MM (24h)
                    } else {
                        showMessage("Time Missing", "Please select a time before setting the dose.");
                    }
                } else if (e.target.dataset.action === 'clear') {
                    // Clear the time in Firestore and the local input field
                    timeInput.value = ''; // Clear the input field immediately
                    updateDose(doseId, undefined, ''); 
                }
            }
        });

        // --- Auth and Initialization ---

        /**
         * Listens for real-time changes to today's dose document.
         */
        function startRealtimeListener() {
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }

            const docRef = getTodayDocRef();
            if (!docRef) return;

            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderDosesList(data);
                } else {
                    console.log("No doses configured for today. Showing modal.");
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('doses-modal').classList.remove('hidden');
                }
                
                // No longer toggling #app-wrapper visibility here.
                // The loading spinner in the main content handles the visual delay.

            }, (error) => {
                console.error("Firestore listener error:", error);
                showMessage("Connection Error", "There was an issue loading your tracking data. Check Firebase security rules.");
                
                // Ensure loading spinner is hidden on error so error message is visible
                document.getElementById('loading').classList.add('hidden');
            });
        }

        /**
         * Handles the initial setup of the number of doses per day.
         */
        document.getElementById('set-doses-btn').addEventListener('click', async () => {
            const dosesInput = document.getElementById('doses-input');
            const dosesPerDay = parseInt(dosesInput.value, 10);
            const errorMsg = document.getElementById('modal-error');

            if (dosesPerDay > 0 && dosesPerDay <= 10) {
                errorMsg.classList.add('hidden');
                document.getElementById('doses-modal').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden'); // Show loading before saving
                await saveInitialDoses(dosesPerDay);
            } else {
                errorMsg.classList.remove('hidden');
            }
        });

        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeAppAndAuth() {
            // Check for the user's configuration
            if (typeof firebaseConfig !== 'object' || !firebaseConfig.apiKey) {
                showMessage("Configuration Error", "Firebase configuration is missing or incorrect. Cannot initialize.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('date-display').textContent = formatDisplayDate();
                
                // Auth Logic: Since initialAuthToken is null (for standalone use), sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                document.getElementById('user-id-display').textContent = `User ID: ${userId} (Anon)`;
                
                // Now that we are authenticated, start listening for data
                startRealtimeListener();

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage = "Firebase Authentication is not fully enabled. Please ensure Anonymous sign-in is enabled in your Firebase Console.";
                }
                showMessage("Startup Error", `Failed to initialize the app: ${errorMessage}`);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Start the application lifecycle
        initializeAppAndAuth();
    </script>
</body>
</html>